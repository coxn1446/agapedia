# Apache VirtualHost configuration for AgaPedia MediaWiki
# Place this file in /etc/apache2/sites-available/wiki.conf

<VirtualHost *:80>
    ServerAdmin admin@agapedia.org
    DocumentRoot /var/www/html/wiki
    ServerName agapedia.org
    ServerAlias www.agapedia.org

    # Directory settings
    <Directory /var/www/html/wiki>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # Security headers
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-XSS-Protection "1; mode=block"
    </Directory>

    # Restrict access to sensitive directories
    <Directory /var/www/html/wiki/cache>
        Require all denied
    </Directory>

    <Directory /var/www/html/wiki/includes>
        Require all denied
    </Directory>

    <Directory /var/www/html/wiki/maintenance>
        Require all denied
    </Directory>

    <Directory /var/www/html/wiki/serialized>
        Require all denied
    </Directory>

    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>

    <FilesMatch "(?i:^\.|^#.*#|\.(?:bak|conf|dist|fla|in[ci]|log|psd|sh|sql|sw[op])|~)$">
        Require all denied
    </FilesMatch>

    # Allow uploads directory
    <Directory /var/www/html/wiki/images>
        Options -Indexes
        AllowOverride None
        Require all granted
        
        # Prevent execution of PHP scripts in images directory
        php_admin_flag engine off
        AddType text/plain .html .htm .shtml .php .php3 .php4 .php5 .phtml
    </Directory>

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/wiki_error.log
    CustomLog ${APACHE_LOG_DIR}/wiki_access.log combined

    # Log level
    LogLevel warn
</VirtualHost>

# HTTPS configuration (uncomment after setting up SSL with Let's Encrypt)
#<VirtualHost *:443>
#    ServerAdmin admin@agapedia.org
#    DocumentRoot /var/www/html/wiki
#    ServerName agapedia.org
#    ServerAlias www.agapedia.org
#
#    SSLEngine on
#    SSLCertificateFile /etc/letsencrypt/live/agapedia.org/fullchain.pem
#    SSLCertificateKeyFile /etc/letsencrypt/live/agapedia.org/privkey.pem
#
#    # Same directory configurations as above
#    <Directory /var/www/html/wiki>
#        Options -Indexes +FollowSymLinks
#        AllowOverride All
#        Require all granted
#        Header always set X-Content-Type-Options "nosniff"
#        Header always set X-Frame-Options "SAMEORIGIN"
#        Header always set X-XSS-Protection "1; mode=block"
#        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
#    </Directory>
#
#    # ... (copy other directory restrictions here)
#
#    ErrorLog ${APACHE_LOG_DIR}/wiki_ssl_error.log
#    CustomLog ${APACHE_LOG_DIR}/wiki_ssl_access.log combined
#</VirtualHost>

